# Usage:
#  ansible-playbook -i ../hosts ./main.yml -v
#

- hosts: mng
  remote_user: root
#  sudo: yes

  vars:
    common: ../common

    base_container: base-v1-0
    container_name: base_web-v1-0
    repo_dir: /work/image
    lxc_dir: /var/lib/lxc
    container_dir: '{{ lxc_dir }}/{{ container_name }}'

  tasks:

  - include: "{{ common }}/task.yml"

  - file: path={{ container_dir }} state=absent
  - file: path={{ container_dir }} state=directory

  - shell: tar xfz {{ repo_dir }}/{{ base_container }}.tar.gz
    args:
      chdir: '{{ container_dir }}'

  - template: src=./files/var/lib/lxc/config dest={{ container_dir }}/config mode='0644'

  - template: src=./files/{{ item.name }} dest={{ container_dir }}/rootfs/{{ item.name }} mode={{ item.mode }}
    with_items:
      - { name: '/etc/hostname', mode: '0600' }
    
  - lxc_container: 
      name: '{{ container_name }}'
      container_log: true
      template: debian
      template_options: --arch amd64 --release jessie
      state: stopped
      container_command: |
        apt-get update
        apt-get -y install apache2 iptables strace aptitude
        apt-get clean
        systemctl enable apache2 
    notify:
    - archive

  - file: path={{ repo_dir }} state=directory 

  handlers:

  - name: archive
    shell: tar c config rootfs fstab | gzip > {{ repo_dir }}/{{ container_name }}.tar.gz
    args:
      chdir: '{{ container_dir }}'


